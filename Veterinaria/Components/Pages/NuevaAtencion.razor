@page "/nueva-atencion"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Veterinaria.Models
@inject VeterinariaDbContext DbContext
@inject NavigationManager Navigation

<div class="container" style="max-width: 900px;">
    <div class="card shadow border-0 mb-5">
        <div class="card-header bg-danger text-white py-3">
            <h3 class="mb-0"><i class="bi bi-clipboard2-pulse-fill me-2"></i>Nueva Consulta Veterinaria</h3>
        </div>
        <div class="card-body p-4">

            @if (!string.IsNullOrEmpty(mensajeError))
            {
                <div class="alert alert-danger alert-dismissible fade show">
                    @mensajeError
                    <button type="button" class="btn-close" @onclick="() => mensajeError = null"></button>
                </div>
            }

            @if (mensajeExito)
            {
            }

            @if (mensajeExito)
            {
                <div class="alert alert-success alert-dismissible fade show">
                    <i class="bi bi-check-circle-fill me-2"></i><strong>¡Éxito!</strong> La consulta y el historial se guardaron correctamente.
                </div>
            }

            <EditForm Model="@modelo" OnValidSubmit="GuardarAtencion" FormName="FormConsulta">
                <DataAnnotationsValidator />

                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-primary">Paciente (Mascota)</label>
                        <InputSelect class="form-select form-select-lg" @bind-Value="modelo.IdMascota" required>
                            <option value="0">-- Seleccionar Paciente --</option>
                            @foreach (var m in listaMascotas)
                            {
                                <option value="@m.IdMascota">@m.Nombre (@m.Especie)</option>
                            }
                        </InputSelect>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold text-primary">Veterinario Tratante</label>
                        <InputSelect class="form-select form-select-lg" @bind-Value="modelo.IdVeterinario" required>
                            <option value="0">-- Seleccionar Doctor --</option>
                            @foreach (var v in listaVeterinarios)
                            {
                                <option value="@v.IdVeterinario">
                                    Vet. @v.IdVeterinarioNavigation.Nombres @v.IdVeterinarioNavigation.Apellidos (@v.Especialidad)
                                </option>
                            }
                        </InputSelect>
                    </div>

                    <div class="col-12"><hr /></div>

                    <div class="col-md-12">
                        <label class="form-label fw-bold">Motivo de Consulta</label>
                        <InputText class="form-control" @bind-Value="modelo.Motivo" placeholder="Ej: Vómitos, control vacuna, herida..." />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold">Diagnóstico</label>
                        <InputTextArea class="form-control" @bind-Value="modelo.Diagnostico" rows="4" placeholder="Detalle lo encontrado en la revisión..." />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold">Tratamiento / Receta</label>
                        <InputTextArea class="form-control" @bind-Value="modelo.Tratamiento" rows="4" placeholder="Medicamentos recetados o procedimientos..." />
                    </div>

                    <div class="col-12"><hr /></div>

                    <div class="col-md-4 ms-auto">
                        <label class="form-label fw-bold text-success fs-5">Costo Total (Bs)</label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-success text-white">Bs.</span>
                            <InputNumber class="form-control fw-bold text-end" @bind-Value="modelo.Costo" />
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end gap-3 mt-4">
                    <button type="button" class="btn btn-secondary" @onclick='() => Navigation.NavigateTo("/")'>Cancelar</button>
                    <button type="submit" class="btn btn-danger btn-lg px-5">
                        <i class="bi bi-save-fill me-2"></i>Guardar Consulta
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    private AtencionViewModel modelo = new();

    // Variables para mensajes
    private bool mensajeExito = false;
    private string? mensajeError = null; // Para mostrar errores si ocurren

    private List<Mascota> listaMascotas = new();
    private List<Veterinario> listaVeterinarios = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            listaMascotas = await DbContext.Mascota.OrderBy(m => m.Nombre).ToListAsync();
            listaVeterinarios = await DbContext.Veterinarios
                .Include(v => v.IdVeterinarioNavigation)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            mensajeError = "Error cargando listas: " + ex.Message;
        }
    }

    private async Task GuardarAtencion()
    {
        mensajeError = null; // Limpiar errores previos

        // 1. Validación manual
        if (modelo.IdMascota == 0)
        {
            mensajeError = "⚠️ Debes seleccionar un Paciente.";
            return;
        }
        if (modelo.IdVeterinario == 0)
        {
            mensajeError = "⚠️ Debes seleccionar un Veterinario.";
            return;
        }

        try
        {
            // 2. Guardar ATENCIÓN
            var atencion = new Atencion
            {
                IdMascota = modelo.IdMascota,
                IdVeterinario = modelo.IdVeterinario,
                DescripcionMotivo = modelo.Motivo,
                Costo = modelo.Costo,
                FechaAtencion = DateTime.Now
            };

            DbContext.Atencions.Add(atencion);
            await DbContext.SaveChangesAsync();

            // 3. Guardar HISTORIAL
            if (!string.IsNullOrEmpty(modelo.Diagnostico))
            {
                var historial = new HistorialMedico
                {
                    IdAtencion = atencion.IdAtencion,
                    DiagnosticoDetalle = modelo.Diagnostico,
                    Tratamiento = modelo.Tratamiento,
                    CodHistorial = $"H-{atencion.IdAtencion}"
                };
                DbContext.HistorialMedicos.Add(historial);
                await DbContext.SaveChangesAsync();
            }

            // 4. ÉXITO VISUAL
            mensajeExito = true;
            StateHasChanged(); // <--- FORZAR ACTUALIZACIÓN DE PANTALLA

            await Task.Delay(2000); // Esperar 2 segundos viendo el mensaje
            Navigation.NavigateTo("/");
        }
        catch (Exception ex)
        {
            // Si falla, mostramos el error en pantalla en vez de redirigir
            mensajeError = "❌ Error al guardar en BD: " + ex.Message;
            if (ex.InnerException != null)
            {
                mensajeError += " | Detalle: " + ex.InnerException.Message;
            }
        }
    }

    public class AtencionViewModel
    {
        public int IdMascota { get; set; }
        public int IdVeterinario { get; set; }
        public string? Motivo { get; set; }
        public string? Diagnostico { get; set; }
        public string? Tratamiento { get; set; }
        public decimal Costo { get; set; }
    }
}