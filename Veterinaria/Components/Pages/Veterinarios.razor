@page "/veterinarios"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Veterinaria.Models
@inject VeterinariaDbContext DbContext

<div class="d-flex justify-content-between mb-4 align-items-center">
    <h3 class="text-info">
        <i class="bi bi-heart-pulse-fill me-2"></i>Staff Médico
    </h3>
    <a href="/agregar-veterinario" class="btn btn-info text-white shadow-sm">
        <i class="bi bi-person-plus-fill me-1"></i> Contratar Veterinario
    </a>
</div>

@if (lista == null)
{
    <p><em>Cargando...</em></p>
}
else
{
    <div class="card shadow-sm border-0">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-info text-white">
                <tr>
                    <th>Nombre Completo</th>
                    <th>Especialidad</th>
                    <th>Contacto</th>
                    <th>Sueldo</th>
                    <th class="text-end">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var v in lista)
                {
                    <tr>
                        <td class="fw-bold">
                            Dr/a. @v.IdVeterinarioNavigation?.Nombres @v.IdVeterinarioNavigation?.Apellidos
                        </td>
                        <td><span class="badge bg-light text-dark border">@v.Especialidad</span></td>
                        <td>
                            <small>
                                <i class="bi bi-telephone"></i> @v.IdVeterinarioNavigation?.Telefono <br />
                                <i class="bi bi-envelope"></i> @v.IdVeterinarioNavigation?.Email
                            </small>
                        </td>
                        <td class="text-success fw-bold">Bs. @(v.Sueldo?.ToString("N2"))</td>
                        <td class="text-end">
                            <div class="btn-group">
                                <a href="/agregar-veterinario/@v.IdVeterinario" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-pencil-square"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger ms-1" @onclick="() => Eliminar(v.IdVeterinario)">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<Veterinario> lista;

    protected override async Task OnInitializedAsync()
    {
        await CargarLista();
    }

    private async Task CargarLista()
    {
        // Incluimos la tabla Persona para ver el nombre
        lista = await DbContext.Veterinarios
            .Include(v => v.IdVeterinarioNavigation)
            .ToListAsync();
    }

    private async Task Eliminar(int id)
    {
        var vet = await DbContext.Veterinarios.FindAsync(id);
        if (vet != null)
        {
            // Primero borramos el rol de veterinario
            DbContext.Veterinarios.Remove(vet);

            // Opcional: ¿Borrar también a la Persona?
            // Por seguridad, dejemos a la persona en la base de datos por si tiene otros roles,
            // o bórrala si prefieres limpieza total:
            // var persona = await DbContext.Persona.FindAsync(id);
            // if(persona != null) DbContext.Persona.Remove(persona);

            await DbContext.SaveChangesAsync();
            await CargarLista();
        }
    }
}